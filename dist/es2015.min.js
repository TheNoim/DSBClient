"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _dsbapi=require("dsbapi");var _dsbapi2=_interopRequireDefault(_dsbapi);var _bluebird=require("bluebird");var _bluebird2=_interopRequireDefault(_bluebird);var _requestPromise=require("request-promise");var _requestPromise2=_interopRequireDefault(_requestPromise);var _cheerio=require("cheerio");var _cheerio2=_interopRequireDefault(_cheerio);require("datejs");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var DSBClient=function(){function DSBClient(username,password,cookiejar){_classCallCheck(this,DSBClient);this.username=username;this.password=password;this.cookiejar=cookiejar;if(this.cookiejar){this.api=new _dsbapi2.default(this.username,this.password,this.cookiejar)}else{this.api=new _dsbapi2.default(this.username,this.password)}this.fetch=this.fetch.bind(this)}_createClass(DSBClient,[{key:"fetch",value:function fetch(){return this.api.getData().then(DSBClient._filter)}}],[{key:"_filter",value:function _filter(data){return new _bluebird2.default(function(resolve,reject){if(!data)return reject(new Error("Returned data is null or undefined."));if(data["Resultcode"]!==0)return reject(new Error("Data result code isn't 0. Code: "+data["Resultcode"]));if(!data["ResultMenuItems"])return reject(new Error("No field ResultMenuItems on returned data."));if(!Array.isArray(data["ResultMenuItems"]))return reject(new Error("ResultMenuItems isn't an array."));if(data["ResultMenuItems"].length===0)return reject(new Error("ResultMenuItems length is 0."));var ResultMenuItems=data["ResultMenuItems"];var Inhalte=DSBClient._fromArrayByKeyAndValue(ResultMenuItems,"Title","Inhalte");if(Inhalte===false)return reject(new Error("Can't find {Title:'Inhalte'} in 'ResultMenuItems'."));if(!Inhalte["Childs"])return reject(new Error("'Childs' in 'Inhalte' is null or undefined."));if(!Array.isArray(Inhalte["Childs"]))return reject(new Error("'Childs' in 'Inhalte' isn't an array."));if(Inhalte["Childs"].length===0)return reject(new Error("The length of 'Childs' in 'Inhalte' is 0."));var InhalteChilds=Inhalte["Childs"];return _bluebird2.default.map(InhalteChilds,function(child){return DSBClient._RootResolver(child)}).then(function(Childs){return _bluebird2.default.map(Childs,function(child,index){InhalteChilds[index]["Childs"]=child;delete InhalteChilds[index]["Root"];delete InhalteChilds[index]["NewCount"];delete InhalteChilds[index]["SaveLastState"];delete InhalteChilds[index]["Index"];return _bluebird2.default.resolve()}).then(function(){return _bluebird2.default.resolve(InhalteChilds)})}).then(function(NewInhalte){var fdata={};return _bluebird2.default.map(NewInhalte,function(method){if(!method)return _bluebird2.default.resolve();if(method["MethodName"]==="timetable"){return DSBClient._processed_timetable(method["Childs"]).then(function(tdata){fdata[tdata.kind]=tdata.data})}else if(method["MethodName"]==="tiles"){return DSBClient._processed_tiles(method["Childs"]).then(function(tdata){fdata[tdata.kind]=tdata.data})}else if(method["MethodName"]==="news"){return DSBClient._processed_news(method["Childs"]).then(function(tdata){fdata[tdata.kind]=tdata.data})}else{return _bluebird2.default.resolve()}}).then(function(){return _bluebird2.default.resolve(fdata)})}).then(function(data){resolve(data)})})}},{key:"_fromArrayByKeyAndValue",value:function _fromArrayByKeyAndValue(array,key,value){for(var i=0;i<array.length;i++){if(array[i][key]===value)return array[i]}return false}},{key:"_RootResolver",value:function _RootResolver(object){return new _bluebird2.default(function(resolve,reject){if(!object)return reject(new Error("Given parameter is null or undefined."));if((typeof object==="undefined"?"undefined":_typeof(object))!=="object")return reject(new Error("Given parameter is not an object."));if(!object["Root"])return reject(new Error("'Root' filed of given object is null or undefined."));if(_typeof(object["Root"])!=="object")return reject(new Error("'Root' field of given object isn't an object."));if(!object["Root"]["Childs"])return reject(new Error("'Childs' field in given object 'Root' is null or undefined."));if(!Array.isArray(object["Root"]["Childs"]))return reject(new Error("'Childs' field in given object 'Root' is not an array."));resolve(object["Root"]["Childs"])})}},{key:"_processed_timetable",value:function _processed_timetable(timetables){return _bluebird2.default.map(timetables,function(table){if(!table["Childs"])return _bluebird2.default.reject(new Error("Timetable has no child array."));if(!Array.isArray(table["Childs"]))return _bluebird2.default.reject(new Error("Timetable child field is not an array."));if(table["Childs"].length===0)return _bluebird2.default.reject(new Error("Timetable child array length is 0."));if(_typeof(table["Childs"][0])!=="object"||!table["Childs"][0]["Detail"])return _bluebird2.default.reject(new Error("Corrupted timetable."));return(0,_requestPromise2.default)({uri:table["Childs"][0]["Detail"],transform:function transform(body){return _cheerio2.default.load(body)}}).then(function($){debugger;var MonTitle=$(".mon_title");if(!MonTitle.text())return _bluebird2.default.reject(new Error("Can not find 'mon_title' in timetable."));if(MonTitle.text().match(/\d*\.\d*\.\d*/).length===0)return _bluebird2.default.reject(new Error("Can not find date of timetable."));return new _bluebird2.default(function(resolve,reject){try{var date=Date.parse(MonTitle.text().match(/\d*\.\d*\.\d*/)[0]);resolve({src:table["Childs"][0]["Detail"],date:Date.parse(MonTitle.text().match(/\d*\.\d*\.\d*/)[0]),refreshed:Date.parse(table["Childs"][0]["Date"])})}catch(e){reject(new Error("Can't parse date of timetable."))}})})}).then(function(timetables){return _bluebird2.default.resolve({kind:"timetables",data:timetables})})}},{key:"_processed_news",value:function _processed_news(newspl){return _bluebird2.default.map(newspl,function(news){return _bluebird2.default.resolve({date:news["Date"],title:news["Title"],text:news["Detail"]})}).then(function(data){return _bluebird2.default.resolve({kind:"news",data:data})})}},{key:"_processed_tiles",value:function _processed_tiles(tiles){return _bluebird2.default.map(tiles,function(tile){if(!tile||!tile["Childs"]||!Array.isArray(tile["Childs"]))return _bluebird2.default.reject(new Error("Corrupted tile."));return _bluebird2.default.map(tile["Childs"],function(tile2){return _bluebird2.default.resolve({date:tile2["Date"],title:tile2["Title"],detail:tile2["Detail"]})})}).then(function(data){return _bluebird2.default.resolve({kind:"tiles",data:data.combine()})})}}]);return DSBClient}();module.exports=DSBClient;Array.prototype.combine=function(){var x=[];for(var i=0;i<this.length;i++){if(Array.isArray(this[i])){for(var ii=0;ii<this[i].length;ii++){x.push(this[i][ii])}}}return x};