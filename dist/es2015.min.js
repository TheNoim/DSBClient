"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _dsbapi=require("dsbapi");var _dsbapi2=_interopRequireDefault(_dsbapi);var _bluebird=require("bluebird");var _bluebird2=_interopRequireDefault(_bluebird);var _request=require("request");var _request2=_interopRequireDefault(_request);var _requestProgress=require("request-progress");var _requestProgress2=_interopRequireDefault(_requestProgress);var _cheerio=require("cheerio");var _cheerio2=_interopRequireDefault(_cheerio);require("datejs");var _events=require("events");var _percentageCalc=require("percentage-calc");var _percentageCalc2=_interopRequireDefault(_percentageCalc);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var DSBClient=function(_EventEmitter){_inherits(DSBClient,_EventEmitter);function DSBClient(username,password,cookiejar){_classCallCheck(this,DSBClient);var _this=_possibleConstructorReturn(this,(DSBClient.__proto__||Object.getPrototypeOf(DSBClient)).call(this));_this.username=username;_this.password=password;_this.cookiejar=cookiejar;_this.progress=0;if(_this.cookiejar){_this.api=new _dsbapi2.default(_this.username,_this.password,_this.cookiejar)}else{_this.api=new _dsbapi2.default(_this.username,_this.password)}var self=_this;_this.api.on("progress",function(p){self.progress=_percentageCalc2.default.of(p,50);self.emit("progress",self.progress)});_this.fetch=_this.fetch.bind(_this);_this._filter=_this._filter.bind(_this);_this._processed_timetable=_this._processed_timetable.bind(_this);return _this}_createClass(DSBClient,[{key:"fetch",value:function fetch(){var self=this;self.progress=0;return this.api.getData().then(self._filter)}},{key:"_filter",value:function _filter(data){var self=this;return new _bluebird2.default(function(resolve,reject){if(!data)return reject(new Error("Returned data is null or undefined."));if(data["Resultcode"]!==0)return reject(new Error("Data result code isn't 0. Code: "+data["Resultcode"]));if(!data["ResultMenuItems"])return reject(new Error("No field ResultMenuItems on returned data."));if(!Array.isArray(data["ResultMenuItems"]))return reject(new Error("ResultMenuItems isn't an array."));if(data["ResultMenuItems"].length===0)return reject(new Error("ResultMenuItems length is 0."));var ResultMenuItems=data["ResultMenuItems"];var Inhalte=DSBClient._fromArrayByKeyAndValue(ResultMenuItems,"Title","Inhalte");if(Inhalte===false)return reject(new Error("Can't find {Title:'Inhalte'} in 'ResultMenuItems'."));if(!Inhalte["Childs"])return reject(new Error("'Childs' in 'Inhalte' is null or undefined."));if(!Array.isArray(Inhalte["Childs"]))return reject(new Error("'Childs' in 'Inhalte' isn't an array."));if(Inhalte["Childs"].length===0)return reject(new Error("The length of 'Childs' in 'Inhalte' is 0."));var InhalteChilds=Inhalte["Childs"];return _bluebird2.default.map(InhalteChilds,function(child){return DSBClient._RootResolver(child)}).then(function(Childs){return _bluebird2.default.map(Childs,function(child,index){InhalteChilds[index]["Childs"]=child;delete InhalteChilds[index]["Root"];delete InhalteChilds[index]["NewCount"];delete InhalteChilds[index]["SaveLastState"];delete InhalteChilds[index]["Index"];return _bluebird2.default.resolve()}).then(function(){return _bluebird2.default.resolve(InhalteChilds)})}).then(function(NewInhalte){var fdata={};return _bluebird2.default.map(NewInhalte,function(method){if(!method)return _bluebird2.default.resolve();if(method["MethodName"]==="timetable"){return self._processed_timetable(method["Childs"]).then(function(tdata){fdata[tdata.kind]=tdata.data})}else if(method["MethodName"]==="tiles"){return DSBClient._processed_tiles(method["Childs"]).then(function(tdata){fdata[tdata.kind]=tdata.data})}else if(method["MethodName"]==="news"){return DSBClient._processed_news(method["Childs"]).then(function(tdata){fdata[tdata.kind]=tdata.data})}else{return _bluebird2.default.resolve()}}).then(function(){return _bluebird2.default.resolve(fdata)})}).then(function(data){self.progress=100;self.emit("progress",100);resolve(data)})})}},{key:"_processed_timetable",value:function _processed_timetable(timetables,setProgress,inCount){var self=this;self._timetables=timetables.length;self._progressTrack=Array.apply(null,Array(self._timetables)).map(Number.prototype.valueOf,0);self._currentTimetable=0;self._everyTimetable=50/self._timetables;self.progress=50;function track(){self.progress=50+self._currentTimetable*self._everyTimetable+_percentageCalc2.default.of(self._progressTrack[self._currentTimetable],self._everyTimetable);self.emit("progress",self.progress)}function pro(p){self._progressTrack[self._currentTimetable]=p;track()}return _bluebird2.default.mapSeries(timetables,function(table){if(!table["Childs"])return _bluebird2.default.reject(new Error("Timetable has no child array."));if(!Array.isArray(table["Childs"]))return _bluebird2.default.reject(new Error("Timetable child field is not an array."));if(table["Childs"].length===0)return _bluebird2.default.reject(new Error("Timetable child array length is 0."));if(_typeof(table["Childs"][0])!=="object"||!table["Childs"][0]["Detail"])return _bluebird2.default.reject(new Error("Corrupted timetable."));return new _bluebird2.default(function(resolve,reject){(0,_requestProgress2.default)((0,_request2.default)({uri:table["Childs"][0]["Detail"]},function(error,response,body){if(error||response.statusCode!==200){return reject(new Error("Response code was not 200."))}else{pro(100);self._currentTimetable+=1;var $=_cheerio2.default.load(body);var MonTitle=$(".mon_title");if(!MonTitle.text())return _bluebird2.default.reject(new Error("Can not find 'mon_title' in timetable."));if(MonTitle.text().match(/\d*\.\d*\.\d*/).length===0)return _bluebird2.default.reject(new Error("Can not find date of timetable."));return new _bluebird2.default(function(resolve,reject){try{var date=Date.parse(MonTitle.text().match(/\d*\.\d*\.\d*/)[0]);resolve({src:table["Childs"][0]["Detail"],date:Date.parse(MonTitle.text().match(/\d*\.\d*\.\d*/)[0]),refreshed:Date.parse(table["Childs"][0]["Date"])})}catch(e){reject(new Error("Can't parse date of timetable."))}}).then(resolve).catch(reject)}})).on("progress",function(state){pro(state.percent*100)})})}).then(function(timetables){return _bluebird2.default.resolve({kind:"timetables",data:timetables})})}}],[{key:"_fromArrayByKeyAndValue",value:function _fromArrayByKeyAndValue(array,key,value){for(var i=0;i<array.length;i++){if(array[i][key]===value)return array[i]}return false}},{key:"_RootResolver",value:function _RootResolver(object){return new _bluebird2.default(function(resolve,reject){if(!object)return reject(new Error("Given parameter is null or undefined."));if((typeof object==="undefined"?"undefined":_typeof(object))!=="object")return reject(new Error("Given parameter is not an object."));if(!object["Root"])return reject(new Error("'Root' filed of given object is null or undefined."));if(_typeof(object["Root"])!=="object")return reject(new Error("'Root' field of given object isn't an object."));if(!object["Root"]["Childs"])return reject(new Error("'Childs' field in given object 'Root' is null or undefined."));if(!Array.isArray(object["Root"]["Childs"]))return reject(new Error("'Childs' field in given object 'Root' is not an array."));resolve(object["Root"]["Childs"])})}},{key:"_processed_news",value:function _processed_news(newspl){return _bluebird2.default.map(newspl,function(news){return _bluebird2.default.resolve({date:news["Date"],title:news["Title"],text:news["Detail"]})}).then(function(data){return _bluebird2.default.resolve({kind:"news",data:data})})}},{key:"_processed_tiles",value:function _processed_tiles(tiles){return _bluebird2.default.map(tiles,function(tile){if(!tile||!tile["Childs"]||!Array.isArray(tile["Childs"]))return _bluebird2.default.reject(new Error("Corrupted tile."));return _bluebird2.default.map(tile["Childs"],function(tile2){return _bluebird2.default.resolve({date:tile2["Date"],title:tile2["Title"],detail:tile2["Detail"]})})}).then(function(data){return _bluebird2.default.resolve({kind:"tiles",data:data.combine()})})}}]);return DSBClient}(_events.EventEmitter);module.exports=DSBClient;Array.prototype.combine=function(){var x=[];for(var i=0;i<this.length;i++){if(Array.isArray(this[i])){for(var ii=0;ii<this[i].length;ii++){x.push(this[i][ii])}}}return x};